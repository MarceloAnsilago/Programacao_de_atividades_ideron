{% extends "base.html" %}
{% block title %}{{ perfil|default:"Novo Perfil" }} — Permissões{% endblock %}

{% block content %}
<h2 class="mb-3">
  <i class="bi bi-shield-lock"></i>
  {{ perfil|default:"Novo Perfil" }} — Permissões
</h2>

{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags }} mb-3">{{ m }}</div>
  {% endfor %}
{% endif %}

<form method="post">
  {% csrf_token %}

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <label class="form-label">{{ form.nome.label }}</label>
      {{ form.nome }}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ form.descricao.label }}</label>
      {{ form.descricao }}
    </div>
  </div>

  <h5 class="mt-2 mb-2">Permissões</h5>

  <div class="mb-2 d-flex gap-2">
    <input id="permSearch" class="form-control" placeholder="Filtrar permissões..." style="max-width: 320px;">
    <button type="button" id="checkAll" class="btn btn-sm btn-outline-primary">Selecionar tudo</button>
    <button type="button" id="uncheckAll" class="btn btn-sm btn-outline-secondary">Limpar</button>
  </div>

  <div class="border rounded p-3" style="max-height: 60vh; overflow:auto;">
    {{ form.permissoes }}
  </div>

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-success" type="submit">
      <i class="bi bi-save"></i> Salvar
    </button>
    <a class="btn btn-outline-secondary" href="{% url 'organizacao:politicas_lista' %}">
      Voltar
    </a>
  </div>

  {# mantém a unidade na querystring se veio do seletor (opcional) #}
  {% if request.GET.unidade %}
    <input type="hidden" name="next" value="{% url 'organizacao:politicas_lista' %}">
  {% endif %}
</form>

<script>
  // UX: filtro e (des)selecionar todos
  const box = document.querySelector('.border');
  document.getElementById('checkAll').onclick = () =>
    box.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = true);
  document.getElementById('uncheckAll').onclick = () =>
    box.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
  document.getElementById('permSearch').oninput = (e) => {
    const q = e.target.value.toLowerCase();
    box.querySelectorAll('label').forEach(lb => {
      lb.style.display = lb.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  };
</script>
{% endblock %}
