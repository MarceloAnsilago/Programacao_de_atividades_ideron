{% extends "base.html" %}
{% block title %}Selecionar Unidade — {{ perfil.nome }}{% endblock %}
{% block content %}
<h2 class="mb-3"><i class="bi bi-shield-lock"></i> {{ perfil.nome }} — Selecionar Unidade</h2>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <label class="form-label">Supervisão</label>
    <select id="supervisao" class="form-select">
      <option value="">-- selecione --</option>
      {% for s in supervisoes %}
        <option value="{{ s.id }}">{{ s.nome }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-6">
    <label class="form-label">Unidade</label>
    <select id="unidade" class="form-select" disabled>
      <option value="">-- selecione uma supervisão primeiro --</option>
    </select>
  </div>
</div>

<a id="btnContinuar" class="btn btn-primary disabled" href="#">Continuar</a>

<script>
  const selSup = document.getElementById('supervisao');
  const selUni = document.getElementById('unidade');
  const btn = document.getElementById('btnContinuar');

  selSup.addEventListener('change', async () => {
    const sid = selSup.value;
    selUni.innerHTML = '';
    btn.classList.add('disabled'); btn.href = '#';
    if (!sid) {
      selUni.disabled = true;
      selUni.innerHTML = '<option value="">-- selecione uma supervisão primeiro --</option>';
      return;
    }
    const r = await fetch(`/organizacao/api/unidades/${sid}/`);
    const data = await r.json();
    selUni.disabled = false;
    selUni.innerHTML = '<option value="">-- selecione --</option>';
    data.unidades.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id; opt.textContent = u.nome;
      selUni.appendChild(opt);
    });
  });

  // >>> AQUI: ao escolher a unidade, ir para o editor de PERMISSÕES <<<
  selUni.addEventListener('change', () => {
    const uid = selUni.value;
    if (uid) {
      btn.classList.remove('disabled');
      // Se quiser levar a unidade como contexto (opcional), passa ?unidade=ID
      btn.href = "{% url 'organizacao:politicas_editar' perfil.id %}" + "?unidade=" + uid;
      // Ou, para ir direto sem precisar clicar em "Continuar":
      // window.location.href = "{% url 'organizacao:politicas_editar' perfil.id %}" + "?unidade=" + uid;
    } else {
      btn.classList.add('disabled');
      btn.href = '#';
    }
  });
</script>
{% endblock %}
